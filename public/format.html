<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Format Templates â€¢ Prudential WA Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --line:#e5e7eb; --muted:#6b7280; }
    html,body{ margin:0; background:#f9fafb; color:#111827; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .container{ max-width: 1100px; margin:0 auto; padding: 12px 16px 40px; }

    .nav{
      position: sticky; top: 0; z-index: 1000;
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; background: #111827; color: #fff;
      border-radius: 12px; margin: 0 0 12px;
    }
    .nav .brand{ color:#fff; text-decoration:none; font-weight:700; flex:1; }
    .nav .menu-btn{
      display:inline-flex; align-items:center; justify-content:center;
      background:transparent; border:1px solid #fff; color:#fff;
      border-radius:8px; padding:6px 10px; font-size:16px; line-height:1;
    }
    .nav .links{ display:flex; gap:8px; flex-wrap:wrap; }
    .nav .links a{ color:#fff; text-decoration:none; padding:8px 10px; border-radius:8px; }
    .nav .links a:hover{ background:#1f2937; }
    @media (max-width: 720px){
      .nav{ border-radius:0; margin:0 -16px 12px; padding:12px 16px; }
      .nav .links{ display:none; position:absolute; left:0; right:0; top:56px; background:#111827; padding:8px 16px; flex-direction:column; gap:4px; border-bottom:1px solid #1f2937; }
      .nav.open .links{ display:flex; }
      .nav .menu-btn{ display:inline-flex; }
    }
    @media (min-width: 721px){ .nav .menu-btn{ display:none; } }

    /* Buttons / helpers */
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid #111827; background:#111827; color:#fff; cursor:pointer; }
    .btn.secondary{ background:#fff; color:#111827; }
    .muted{ color: var(--muted); }

    /* Cards / layout */
    .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0; }
    .row{ display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 900px){ .row{ grid-template-columns: 1fr 1fr; } }

    /* Editors */
    textarea{
      width:100%; min-height:160px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:14px; padding:10px; border:1px solid var(--line); border-radius:8px; background:#fff;
    }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0; }
    .chip{ border:1px dashed var(--line); padding:4px 8px; border-radius:999px; cursor:pointer; font-size:12px; background:#fff; }

    pre{ background:#f3f4f6; border:1px solid var(--line); padding:12px; border-radius:8px; overflow:auto; }

    /* Image preview */
    img.preview{ max-width:240px; max-height:160px; display:none; border:1px solid var(--line); border-radius:8px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="nav" data-nav>
    <a class="brand" id="navBrand" href="#"> WA Scheduler</a>
    <button class="menu-btn" id="navToggle" aria-label="Menu" aria-expanded="false">â˜°</button>
    <div class="links" id="navLinks">
      <a id="navHome" href="#">Home</a>
      <a id="navFormat" href="#">Format</a>
      <a id="navExcel" href="#">View Excel</a>
      <a id="navFollow" href="#">Follow-up</a>
      <a href="/workspaces">Switch Excel</a>
    </div>
  </div>

  <div class="container">
    <h2>Message Format</h2>
    <p class="muted">
      Customize the two WhatsApp messages. Placeholders you can use:
      <code>{{client.name}}</code>, <code>{{slotsText}}</code> (broadcast only), <code>{{slotLabel}}</code> (confirmation only).
    </p>

    <!-- Broadcast Image -->
    <div class="card">
      <h3 style="margin-top:0">Broadcast Image (optional)</h3>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <img id="imgPreview" class="preview" alt="" />
        <input id="imgFile" type="file" accept="image/*" />
        <button class="btn" id="imgUpload" type="button">Upload</button>
        <button class="btn secondary" id="imgRemove" type="button">Remove</button>
        <span id="imgState" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:8px;">This image will be attached to your broadcast and follow-up messages.</p>
    </div>

    <div class="row">
      <div class="card">
        <h3 style="margin-top:0">Broadcast Message</h3>
        <div class="chips">
          <span class="chip" data-insert="{{client.name}}">{{client.name}}</span>
          <span class="chip" data-insert="{{slotsText}}">{{slotsText}}</span>
        </div>
        <div style="height:8px"></div>
        <textarea id="tplBroadcast" placeholder="Hi {{client.name}}, here are my available 1-hour meeting slots:

{{slotsText}}

Reply with the number of your preferred slot (e.g., 2)."></textarea>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Confirmation Message</h3>
        <div class="chips">
          <span class="chip" data-insert="{{client.name}}">{{client.name}}</span>
          <span class="chip" data-insert="{{slotLabel}}">{{slotLabel}}</span>
        </div>
        <div style="height:8px"></div>
        <textarea id="tplConfirm" placeholder="ðŸ“Œ Hi {{client.name}}, your appointment is confirmed.

ðŸ—“ {{slotLabel}}

â€“ Your Agent"></textarea>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button class="btn" id="save">Save</button>
        <button class="btn secondary" id="reset">Restore Defaults</button>
        <span id="state" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Preview (example data)</h3>
      <pre id="preview"></pre>
    </div>
  </div>

  <script>
    // Workspace from URL: /w/:ws/format
    const wsId = (location.pathname.match(/^\/w\/([^/]+)/) || [])[1];

    // ----- Navbar wiring -----
    const nav = document.querySelector('[data-nav]');
    const navLinks = document.getElementById('navLinks');
    const navToggle = document.getElementById('navToggle');

    function setNav(){
      document.getElementById('navBrand').href = `/w/${wsId}/`;
      document.getElementById('navHome').href   = `/w/${wsId}/`;
      document.getElementById('navFormat').href = `/w/${wsId}/format`;
      document.getElementById('navExcel').href  = `/w/${wsId}/excel`;
      document.getElementById('navFollow').href = `/w/${wsId}/followup`;
    }
    setNav();

    // Hamburger toggle
    navToggle.addEventListener('click', () => {
      const open = nav.classList.toggle('open');
      navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
    // Close when link clicked
    navLinks.addEventListener('click', (e) => {
      if (e.target.tagName === 'A') {
        nav.classList.remove('open');
        navToggle.setAttribute('aria-expanded', 'false');
      }
    });
    // Close if clicked outside
    document.addEventListener('click', (e) => {
      if (!nav.contains(e.target)) {
        nav.classList.remove('open');
        navToggle.setAttribute('aria-expanded', 'false');
      }
    });

    // ----- Template editor + image -----
    const bEl = document.getElementById('tplBroadcast');
    const cEl = document.getElementById('tplConfirm');
    const stateEl = document.getElementById('state');
    const previewEl = document.getElementById('preview');

    function insertAtCursor(el, text) {
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      el.value = el.value.slice(0, start) + text + el.value.slice(end);
      el.focus();
      el.selectionStart = el.selectionEnd = start + text.length;
      updatePreview();
    }
    document.querySelectorAll('.chip').forEach(ch => {
      ch.addEventListener('click', () => {
        const text = ch.getAttribute('data-insert');
        const ta = ch.closest('.card').querySelector('textarea');
        insertAtCursor(ta, text);
      });
    });

    function render(tpl, ctx) {
      return (tpl || '').replace(/\{\{\s*([a-zA-Z0-9_.]+)\s*\}\}/g, (_, p) => {
        const parts = p.split('.');
        let cur = ctx;
        for (const k of parts) {
          if (cur && Object.prototype.hasOwnProperty.call(cur, k)) cur = cur[k];
          else return `{{${p}}}`;
        }
        return (cur ?? `{{${p}}}`).toString();
      });
    }

    function updatePreview() {
      const example = {
        client: { name: 'John Tan' },
        // Example shows stable numbering with a gap if #2 was taken
        slotsText: '1) 26 Aug 2â€“3pm\n3) 26 Aug 4â€“5pm\n4) 26 Aug 5â€“6pm',
        slotLabel: '26 Aug 2â€“3pm'
      };
      const b = render(bEl.value || bEl.placeholder, example);
      const c = render(cEl.value || cEl.placeholder, example);
      previewEl.textContent = `--- Broadcast ---\n${b}\n\n--- Confirm ---\n${c}`;
    }

    async function loadTemplates() {
      const res = await fetch(`/api/w/${wsId}/templates`);
      const data = await res.json();
      if (data.ok) {
        bEl.value = data.templates.broadcast || bEl.placeholder;
        cEl.value = data.templates.confirm || cEl.placeholder;
        setImage(data.templates.broadcastMediaUrl || '');
        updatePreview();
      }
    }

    async function saveTemplates(reset=false) {
      const payload = reset ? { broadcast:'', confirm:'' } : { broadcast:bEl.value, confirm:cEl.value };
      const res = await fetch(`/api/w/${wsId}/templates`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.ok) {
        stateEl.textContent = 'Saved âœ“';
        setTimeout(()=> stateEl.textContent = '', 1200);
        bEl.value = data.templates.broadcast;
        cEl.value = data.templates.confirm;
        updatePreview();
      } else {
        stateEl.textContent = data.error || 'Save failed';
      }
    }

    document.getElementById('save').addEventListener('click', ()=>saveTemplates(false));
    document.getElementById('reset').addEventListener('click', ()=>saveTemplates(true));
    bEl.addEventListener('input', updatePreview);
    cEl.addEventListener('input', updatePreview);

    // Image upload/remove
    function setImage(url){
      const img = document.getElementById('imgPreview');
      const st  = document.getElementById('imgState');
      if (url) { img.src = url; img.style.display = ''; st.textContent = ''; }
      else { img.src = ''; img.style.display = 'none'; }
    }
    document.getElementById('imgUpload').addEventListener('click', async ()=>{
      const f = document.getElementById('imgFile').files[0];
      const st = document.getElementById('imgState');
      if (!f) { st.textContent = 'Choose an image first.'; return; }
      st.textContent = 'Uploadingâ€¦';
      const fd = new FormData(); fd.append('image', f);
      const res = await fetch(`/api/w/${wsId}/templates-image`, { method:'POST', body: fd });
      const data = await res.json();
      if (!data.ok) { st.textContent = data.error || 'Upload failed'; return; }
      setImage(data.url);
      st.textContent = 'Saved âœ“'; setTimeout(()=> st.textContent='', 1200);
    });
    document.getElementById('imgRemove').addEventListener('click', async ()=>{
      const st = document.getElementById('imgState');
      st.textContent = 'Removingâ€¦';
      const res = await fetch(`/api/w/${wsId}/templates-image`, { method:'DELETE' });
      const data = await res.json();
      if (!data.ok) { st.textContent = data.error || 'Remove failed'; return; }
      setImage('');
      st.textContent = 'Removed âœ“'; setTimeout(()=> st.textContent='', 1200);
    });

    loadTemplates();
  </script>
</body>
</html>
