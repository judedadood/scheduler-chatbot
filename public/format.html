<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Format Templates ‚Ä¢ WA Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:24px; }
    /* Navbar (unified across pages) */
    .nav { display:flex; align-items:center; gap:16px; padding:12px 16px; background:#111827; color:#fff; border-radius:12px; margin-bottom:16px; }
    .nav a { color:#fff; text-decoration:none; padding:6px 10px; border-radius:6px; }
    .nav a:hover { background:#1f2937; }
    .brand { font-weight:700; margin-right:8px; }

    .container { max-width:900px; margin:0 auto; }
    .row { display:grid; grid-template-columns: 1fr; gap:16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    textarea { width:100%; min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .actions { display:flex; gap:12px; margin-top:8px; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#111827; color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111827; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0; }
    .chip { border:1px dashed #d1d5db; padding:4px 8px; border-radius:999px; cursor:pointer; font-size:12px; background:#f9fafb; }
    pre { background:#f3f4f6; padding:12px; border-radius:8px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <!-- Unified Navbar -->
  <div class="nav">
    <span class="brand">WhatsApp Scheduler</span>
    <a href="/">Home</a>
    <a href="/format">Format</a>
    <a href="/excel">View Excel</a>
    <a href="/followup">Follow-up</a>
  </div>

  <div class="container">
    <h2>Message Format</h2>

    <!-- NEW: Broadcast Image -->
    <div class="card" style="margin-bottom:16px;">
      <h3>Broadcast Header Image (optional)</h3>
      <p>This image will be sent together with your broadcast message.</p>
      <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
        <img id="imgPreview" src="" alt="No image" style="max-width:280px; max-height:180px; border:1px solid #e5e7eb; border-radius:8px; object-fit:contain; background:#fafafa;">
        <div>
          <form id="imgForm">
            <input type="file" id="imgFile" name="image" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
            <div class="actions" style="margin-top:8px;">
              <button class="btn" type="submit">Upload Image</button>
              <button class="btn secondary" id="clearImg" type="button">Remove Image</button>
            </div>
          </form>
          <div id="imgState" style="margin-top:8px; color:#6b7280;"></div>
        </div>
      </div>
    </div>

    <p>Customize the two WhatsApp messages. You can use these placeholders:</p>
    <ul>
      <li><code>{{client.name}}</code> ‚Äì client‚Äôs name</li>
      <li><code>{{slotsText}}</code> ‚Äì list of available slots (broadcast only)</li>
      <li><code>{{slotLabel}}</code> ‚Äì the chosen slot (confirmation only), e.g. ‚Äú26 Aug 2‚Äì3pm‚Äù</li>
    </ul>

    <div class="row">
      <div class="card">
        <h3>Broadcast Message</h3>
        <div class="chips">
          <span class="chip" data-insert="{{client.name}}">{{client.name}}</span>
          <span class="chip" data-insert="{{slotsText}}">{{slotsText}}</span>
        </div><br>
        <textarea id="tpl-broadcast" placeholder="Hi {{client.name}}, here are my available 1-hour meeting slots:

{{slotsText}}

Reply with the number of your preferred slot (e.g., 2)."></textarea>
      </div>

      <div class="card">
        <h3>Confirmation Message</h3>
        <div class="chips">
          <span class="chip" data-insert="{{client.name}}">{{client.name}}</span>
          <span class="chip" data-insert="{{slotLabel}}">{{slotLabel}}</span>
        </div><br>
        <textarea id="tpl-confirm" placeholder="üìå Hi {{client.name}}, your appointment is confirmed.

üóì {{slotLabel}}

‚Äì Your Agent"></textarea>
      </div>

      <div class="actions card">
        <button class="btn" id="save">Save</button>
        <button class="btn secondary" id="reset">Restore Defaults</button>
        <span id="state" style="margin-left:8px;"></span>
      </div>

      <div class="card">
        <h3>Preview (example data)</h3>
        <pre id="preview"></pre>
      </div>
    </div>
  </div>

  <script>
    const bEl = document.getElementById('tpl-broadcast');
    const cEl = document.getElementById('tpl-confirm');
    const stateEl = document.getElementById('state');
    const previewEl = document.getElementById('preview');

    const imgPreview = document.getElementById('imgPreview');
    const imgForm = document.getElementById('imgForm');
    const imgFile = document.getElementById('imgFile');
    const clearImgBtn = document.getElementById('clearImg');
    const imgState = document.getElementById('imgState');

    function insertAtCursor(el, text) {
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      el.value = el.value.slice(0, start) + text + el.value.slice(end);
      el.focus();
      el.selectionStart = el.selectionEnd = start + text.length;
      updatePreview();
    }

    document.querySelectorAll('.chip').forEach(ch => {
      ch.addEventListener('click', () => {
        const text = ch.getAttribute('data-insert');
        const target = ch.closest('.card').querySelector('textarea');
        insertAtCursor(target, text);
      });
    });

    async function loadTemplates() {
      const res = await fetch('/templates');
      const data = await res.json();
      if (data.ok) {
        bEl.value = data.templates.broadcast || bEl.placeholder;
        cEl.value = data.templates.confirm || cEl.placeholder;
        if (data.templates.broadcastImageUrl) {
          imgPreview.src = data.templates.broadcastImageUrl;
          imgPreview.style.opacity = '1';
        } else {
          imgPreview.removeAttribute('src');
          imgPreview.style.opacity = '0.3';
        }
        updatePreview();
      }
    }

    async function saveTemplates(reset = false) {
      const payload = reset
        ? { broadcast: '', confirm: '' } // server keeps/clears image separately
        : { broadcast: bEl.value, confirm: cEl.value };

      const res = await fetch('/templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.ok) {
        stateEl.textContent = 'Saved ‚úì';
        setTimeout(() => stateEl.textContent = '', 1200);
        bEl.value = data.templates.broadcast;
        cEl.value = data.templates.confirm;
        updatePreview();
      } else {
        stateEl.textContent = 'Save failed';
      }
    }

    function render(tpl, ctx) {
      return (tpl || '').replace(/\{\{\s*([a-zA-Z0-9_.]+)\s*\}\}/g, (_, path) => {
        const parts = path.split('.');
        let cur = ctx;
        for (const p of parts) {
          if (cur && Object.prototype.hasOwnProperty.call(cur, p)) cur = cur[p];
          else return `{{${path}}}`;
        }
        return (cur ?? `{{${path}}}`).toString();
      });
    }

    function updatePreview() {
      const example = {
        client: { name: 'John Tan' },
        slotsText: '1) 26 Aug 2‚Äì3pm\n2) 26 Aug 3:30‚Äì4:30pm',
        slotLabel: '26 Aug 2‚Äì3pm'
      };
      const b = render(bEl.value || bEl.placeholder, example);
      const c = render(cEl.value || cEl.placeholder, example);
      previewEl.textContent = `--- Broadcast ---\n${b}\n\n--- Confirm ---\n${c}`;
    }

    document.getElementById('save').addEventListener('click', () => saveTemplates(false));
    document.getElementById('reset').addEventListener('click', () => saveTemplates(true));
    bEl.addEventListener('input', updatePreview);
    cEl.addEventListener('input', updatePreview);

    // ---- Image upload handling
    imgForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!imgFile.files.length) return;
      imgState.textContent = 'Uploading...';
      const fd = new FormData();
      fd.append('image', imgFile.files[0]);
      const res = await fetch('/upload-broadcast-image', { method: 'POST', body: fd });
      const data = await res.json();
      if (data.ok) {
        imgPreview.src = data.url;
        imgPreview.style.opacity = '1';
        imgState.textContent = 'Image saved ‚úì';
      } else {
        imgState.textContent = data.error || 'Upload failed';
      }
    });

    clearImgBtn.addEventListener('click', async () => {
      imgState.textContent = 'Clearing...';
      const res = await fetch('/clear-broadcast-image', { method:'POST' });
      const data = await res.json();
      if (data.ok) {
        imgPreview.removeAttribute('src');
        imgPreview.style.opacity = '0.3';
        imgState.textContent = 'Image removed ‚úì';
      } else {
        imgState.textContent = data.error || 'Failed to remove';
      }
    });

    loadTemplates();
  </script>
</body>

