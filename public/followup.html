<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Follow-up • WA Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:24px; }
    .nav { display:flex; align-items:center; gap:16px; padding:12px 16px; background:#111827; color:#fff; border-radius:12px; margin-bottom:16px; }
    .nav a { color:#fff; text-decoration:none; padding:6px 10px; border-radius:6px; }
    .nav a:hover { background:#1f2937; }
    .brand { font-weight:700; margin-right:8px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; }
    textarea { width:100%; min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#111827; color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111827; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0; }
    .chip { border:1px dashed #d1d5db; padding:4px 8px; border-radius:999px; cursor:pointer; font-size:12px; background:#f9fafb; }
    pre { background:#f3f4f6; padding:12px; border-radius:8px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="nav">
    <span class="brand">WhatsApp Scheduler</span>
    <a href="/">Home</a>
    <a href="/format">Format</a>
    <a href="/excel">View Excel</a>
    <a href="/followup">Follow-up</a>
  </div>

  <div class="card">
    <h2>Follow-up Message (for Pending clients)</h2>
    <p>This will be sent only to clients whose <strong>Status</strong> is <code>Pending</code>. It uses the original numbering from your last broadcast (e.g., <code>1,3,4,5</code> if <code>2</code> is taken).</p>

    <div class="chips">
      <span class="chip" data-insert="{{client.name}}">{{client.name}}</span>
      <span class="chip" data-insert="{{slotsText}}">{{slotsText}}</span>
    </div><br>

    <textarea id="tpl-followup" placeholder="Hi {{client.name}}, just checking in — here are the remaining available slots:

{{slotsText}}

Reply with the number of your preferred slot (e.g., 2)."></textarea>

    <div style="display:flex; gap:12px; align-items:center; margin-top:12px;">
      <button class="btn" id="save">Save</button>
      <button class="btn secondary" id="reset">Restore Default</button>
      <span id="state" style="color:#6b7280;"></span>
    </div>
  </div>

  <div class="card">
    <h3>Preview</h3>
    <pre id="preview"></pre>
    <div style="margin-top:12px;">
      <button class="btn" id="send">Send Follow-up to clients with status "Pending"</button>
      <span id="sendState" style="margin-left:8px; color:#6b7280;"></span>
    </div>
  </div><br><br><br>

  <script>
    const el = document.getElementById('tpl-followup');
    const stateEl = document.getElementById('state');
    const previewEl = document.getElementById('preview');
    const sendState = document.getElementById('sendState');

    function insertAtCursor(textarea, text) {
      const start = textarea.selectionStart ?? textarea.value.length;
      const end = textarea.selectionEnd ?? textarea.value.length;
      textarea.value = textarea.value.slice(0, start) + text + textarea.value.slice(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + text.length;
      updatePreview();
    }

    document.querySelectorAll('.chip').forEach(ch => {
      ch.addEventListener('click', () => insertAtCursor(el, ch.getAttribute('data-insert')));
    });

    function render(tpl, ctx) {
      return (tpl || '').replace(/\{\{\s*([a-zA-Z0-9_.]+)\s*\}\}/g, (_, path) => {
        const parts = path.split('.');
        let cur = ctx;
        for (const p of parts) {
          if (cur && Object.prototype.hasOwnProperty.call(cur, p)) cur = cur[p];
          else return `{{${path}}}`;
        }
        return (cur ?? `{{${path}}}`).toString();
      });
    }

    async function loadTemplates() {
      const res = await fetch('/templates');
      const data = await res.json();
      if (data.ok) {
        el.value = data.templates.followup || el.placeholder;
        updatePreview();
      }
    }

    async function loadStableSlotsText() {
      const res = await fetch('/slots-stable-text');
      const data = await res.json();
      return data.ok ? data.slotsText : '(All slots have been booked)';
    }

    async function updatePreview() {
      const slotsText = await loadStableSlotsText();
      const example = { client: { name: 'John Tan' }, slotsText };
      previewEl.textContent = render(el.value || el.placeholder, example);
    }

    document.getElementById('save').addEventListener('click', async () => {
      const res = await fetch('/templates', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ followup: el.value })
      });
      const data = await res.json();
      stateEl.textContent = data.ok ? 'Saved ✓' : 'Save failed';
      setTimeout(() => stateEl.textContent = '', 1200);
      updatePreview();
    });

    document.getElementById('reset').addEventListener('click', async () => {
      const res = await fetch('/templates', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ followup: '' })
      });
      const data = await res.json();
      el.value = data.templates.followup;
      stateEl.textContent = 'Restored ✓';
      setTimeout(() => stateEl.textContent = '', 1200);
      updatePreview();
    });

    document.getElementById('send').addEventListener('click', async () => {
      sendState.textContent = 'Sending...';
      const res = await fetch('/followup-send', { method: 'POST' });
      const data = await res.json();
      sendState.textContent = data.ok
        ? `Done. Sent to ${data.sentTo}.`
        : (data.error || 'Failed.');
      setTimeout(() => sendState.textContent = '', 2500);
    });

    el.addEventListener('input', updatePreview);

    loadTemplates();
    updatePreview();
  </script>
</body>
</html>
